<!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>Server API Updater</title>
      <link rel="icon" href="/images/favicon-admin.png" type="image/png">
      <link href="/node_modules/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
      <link rel="stylesheet" href="/node_modules/bootstrap-icons/font/bootstrap-icons.css">
      <link rel="stylesheet" href="/node_modules/@fortawesome/fontawesome-free/css/all.min.css">
      <link href="/node_modules/sweetalert2/dist/sweetalert2.min.css" rel="stylesheet">
      <link rel="stylesheet" href="/css/admin-update-checke.css">
   </head>
   <body class="bg-light d-flex flex-column min-vh-100">
      <%- include('partials/nav') %>
      <main class="flex-grow-1 pb-5">
         <div class="container py-4">
            <div class="card shadow-sm border-0 mb-4">
               <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center py-3">
                  <h2 class="h5 mb-0 d-flex align-items-center">
                     <i class="bi bi-cloud-arrow-up-fill text-primary me-2"></i>
                     Server API Updater
                  </h2>
                  <div class="d-flex">
                     <a href="/admin/update/check" class="btn btn-outline-info btn-sm me-2 d-flex align-items-center">
                     <i class="bi bi-search me-1"></i> Check
                     </a>
                     <% if (filesToUpdate.length > 0) { %>
                     <button type="button" class="btn btn-warning btn-sm me-2 d-flex align-items-center" id="backupButton">
                     <i class="bi bi-file-earmark-zip me-1"></i> Backup
                     </button>
                     <% } %>
                     <form method="POST" action="/admin/update" style="display: inline;">
                        <button type="submit" class="btn btn-primary btn-sm me-2 d-flex align-items-center" id="updateButton" <%= filesToUpdate.length === 0 ? 'disabled' : '' %>>
                        <i class="bi bi-download me-1"></i> Update
                        </button>
                     </form>
                     <button type="button" class="btn btn-outline-info btn-sm d-flex align-items-center" data-bs-toggle="modal" data-bs-target="#updateInfoModal">
                     <i class="fas fa-info-circle me-1"></i> Info
                     </button>
                  </div>
               </div>
               <div class="card-body">
                  <% if (typeof successMessage !== 'undefined' && successMessage) { %>
                  <div class="alert alert-success d-flex align-items-center mb-4" role="alert" id="successAlert">
                     <i class="bi bi-check-circle-fill me-2"></i>
                     <div><%= successMessage %></div>
                  </div>
                  <% } %>
                  <!-- Прогресс-бар (изначально скрыт) -->
                  <div class="mb-4 d-none" id="progressContainer">
                     <div class="d-flex justify-content-between mb-2">
                        <span class="small text-muted" id="progressText">Preparing update...</span>
                        <span class="small text-muted" id="progressPercent">0%</span>
                     </div>
                     <div class="progress" style="height: 8px;">
                        <div id="updateProgress" class="progress-bar progress-bar-striped progress-bar-animated" 
                           role="progressbar" style="width: 0%"></div>
                     </div>
                  </div>
                  <% if (checked && filesToUpdate.length > 0) { %>
                  <div class="alert backup-alert d-flex align-items-start mb-4">
                     <div class="me-3">
                        <i class="bi bi-exclamation-triangle-fill text-warning blink" style="font-size: 1.5rem;"></i>
                     </div>
                     <div>
                        <h5 class="alert-heading mb-2">Attention!</h5>
                        <p class="mb-0">Before applying the update, it is <strong>strongly recommended</strong> to back up any files you have modified. Otherwise, all your changes will be overwritten by the default files included in the update.</p>
                        <div class="mt-2">
                           <a href="#" class="btn btn-sm btn-outline-warning" data-bs-toggle="modal" data-bs-target="#backupModal">
                           <i class="bi bi-file-earmark-zip me-1"></i> How to backup
                           </a>
                        </div>
                     </div>
                  </div>
                  <% } %>
                  <div class="mb-4">
                     <h5 class="d-flex align-items-center mb-3">
                        <i class="bi bi-terminal-fill text-secondary me-2"></i>
                        Update Log
                     </h5>
                     <div class="bg-light p-3 rounded-2 font-monospace small" 
                        style="max-height: 300px; overflow-y: auto;" id="updateLogContainer">
                        <%- updateLog %>
                     </div>
                  </div>
                  <% if (checked) { %>
                  <% if (filesToUpdate.length > 0) { %>
                  <div class="alert alert-warning d-flex align-items-center mb-4" role="alert">
                     <i class="bi bi-exclamation-triangle-fill me-2"></i>
                     <div>
                        <strong>Files to update detected.</strong> More details about the update can be found on the 
                        <a href="https://forum.ragezone.com/threads/blade-soul-api-server-game-launcher.1234817/" target="_blank" class="alert-link">forum</a> 
                        and the 
                        <a href="https://github.com/war100ck/Server-Api-BnS-2017?tab=readme-ov-file#additions--fixes" target="_blank" class="alert-link">GitHub page</a>.
                     </div>
                  </div>
                  <div class="mb-4">
                     <h5 class="d-flex align-items-center mb-3">
                        <i class="bi bi-file-earmark-diff-fill text-warning me-2"></i>
                        Files to update (<%= filesToUpdate.length %>)
                     </h5>
                     <div class="list-group">
                        <% filesToUpdate.forEach(file => { %>
                        <div class="list-group-item list-group-item-action small d-flex align-items-center">
                           <i class="bi bi-file-earmark-code me-2 text-muted"></i>
                           <%= file %>
                        </div>
                        <% }) %>
                     </div>
                  </div>
                  <% } else { %>
                  <div class="alert alert-success d-flex align-items-center" role="alert">
                     <i class="bi bi-check-circle-fill me-2"></i>
                     <div><strong>All files are up to date!</strong></div>
                  </div>
                  <% } %>
                  <% } %>
               </div>
            </div>
         </div>
         <!-- Модальное окно с инструкцией по бэкапу -->
         
      </main>
	  <%- include('partials/updateBackupCheckerModal') %>
      <%- include('partials/adminFooter') %>
      <%- include('partials/updateInfoModal') %>
      <script src="/node_modules/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
      <script src="/node_modules/sweetalert2/dist/sweetalert2.all.min.js"></script>
      <script src="/js/admin-update-checker.js"></script>
   </body>
</html>