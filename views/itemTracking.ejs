<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Item Tracking for <%= userId %></title>
    <link rel="icon" href="/images/favicon-admin.png" type="image/png">
    <link href="/node_modules/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/node_modules/bootstrap-icons/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/node_modules/@fortawesome/fontawesome-free/css/all.min.css">
    <link rel="stylesheet" href="/css/admin-itemTracking.css">
</head>
<body class="bg-light d-flex flex-column min-vh-100">
    <!-- Navigation Header -->
    <%- include('partials/nav') %>

    <main class="flex-grow-1 pb-5">
        <div class="container py-4" id="pageContent">
            <!-- Toast Container -->
            <div class="toast-container" id="toastContainer"></div>

            <!-- Заголовок и информация о пользователе -->
            <div class="d-flex justify-content-between align-items-center mb-4 flex-column flex-md-row">
                <div class="account-management-block mb-4 mb-md-0 p-3 rounded-3 shadow-sm">
                    <h2 class="mb-3 d-flex align-items-center">
                        <i class="fas fa-envelope-open-text fs-4 text-primary me-2"></i>Item Tracking
                    </h2>
                    <!-- Первый ряд бейджей -->
                    <div class="d-flex flex-wrap align-items-center gap-2 mb-2">
                        <span class="badge bg-secondary py-2 px-3 d-flex align-items-center">
                            <i class="fas fa-id-card me-2"></i>
                            <span class="fw-medium">User ID: <%= userId %></span>
                        </span>
                        <span class="badge bg-primary py-2 px-3 d-flex align-items-center">
                            <i class="fas fa-search me-2"></i>
                            <span class="fw-medium">Item Tracking System</span>
                        </span>
                    </div>
                    <!-- Второй ряд бейджей -->
                    <div class="d-flex flex-wrap align-items-center gap-2 mb-2">
                        <span class="badge bg-info py-2 px-3 d-flex align-items-center">
                            <i class="bi bi-envelope me-2"></i>
                            <span class="fw-medium">Mail & Gift Box Tracking</span>
                        </span>
                        <span class="badge bg-success py-2 px-3 d-flex align-items-center">
                            <i class="bi bi-database me-2"></i>
                            <span id="itemsCount" class="fw-medium">Loading items...</span>
                        </span>
                    </div>
                </div>
                <!-- dropdown меню -->
                <div class="d-flex ms-md-auto mt-3 mt-md-0">
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-primary dropdown-toggle py-1 px-2" type="button" id="userActionsDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-user-cog fa-sm me-1"></i> Actions
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end shadow-sm" aria-labelledby="userActionsDropdown">
                            <li>
                                <h6 class="dropdown-header">User Actions</h6>
                            </li>
                            <li><a class="dropdown-item py-2" href="edit-character?userId=<%= userId %>"><i class="fas fa-user-edit fa-fw me-2 text-primary"></i>Edit Character</a></li>
                            <li><a class="dropdown-item py-2" href="add-deposit?userId=<%= userId %>"><i class="fas fa-coins fa-fw me-2 text-success"></i>Add Deposit</a></li>
                            <li><a class="dropdown-item py-2" href="add-item?userId=<%= userId %>"><i class="fas fa-paper-plane fa-fw me-2 text-info"></i>Sending Items</a></li>
                            <li>
                                <hr class="dropdown-divider my-1">
                            </li>
                            <li>
                                <h6 class="dropdown-header">Administration</h6>
                            </li>
							<li>
                            <a class="dropdown-item py-2" href="add-vip?userId=<%= userId %>">
                            <i class="fas fa-crown fa-fw me-2 text-warning"></i>VIP Management
                            </a>
                            </li>
                            <li class="dropdown-submenu">
                                <a class="dropdown-item py-2 d-flex justify-content-between align-items-center" href="add-ban?userId=<%= userId %>">
                                    <span>
                                        <i class="fas fa-gavel fa-fw me-2 text-danger"></i>Ban Management
                                    </span>
                                    <span class="dropdown-arrow ms-2">›</span>
                                </a>
                                <ul class="dropdown-menu shadow-sm">
                                    <li>
                                        <a class="dropdown-item py-2" href="block?userId=<%= userId %>">
                                            <i class="fas fa-user-slash fa-fw me-2 text-secondary"></i>Character Block
                                        </a>
                                    </li>
                                </ul>
                            </li>
                        </ul>
                    </div>
                    <button class="btn btn-sm btn-outline-primary ms-2 py-1 px-2" data-bs-toggle="modal" data-bs-target="#itemTrackingInfoModal">
                        <i class="fas fa-info-circle fa-sm me-1"></i> Info
                    </button>
                </div>
            </div>

            <div class="item-tracking-container">
                <!-- Items Info Card -->
                <div class="card mb-3 item-tracking-card">
                    <div class="card-body py-2">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <span class="items-info">
                                    <i class="bi bi-database"></i> Items Database: 
                                    <span id="itemsCountText">loading...</span> items loaded
                                </span>
                            </div>
                            <div class="col-md-4 text-end">
                                <button class="btn btn-outline-primary btn-sm" id="reloadItemsBtn">
                                    <i class="bi bi-arrow-clockwise"></i> Refresh Cache
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Search Criteria Card -->
                <div class="card mb-4 item-tracking-card">
                    <div class="card-header item-tracking-card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-search me-2"></i>Search Criteria
                        </h5>
                    </div>
                    <div class="card-body">
                        <form id="searchForm">
                            <div class="row g-3 align-items-end">
                                <div class="col-md-3">
                                    <label class="form-label">Username</label>
                                    <input type="text" class="form-control" name="account" id="account" 
                                           placeholder="Enter username">
                                    <small class="form-text text-muted">Searches by exact UserName match</small>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Character Name</label>
                                    <input type="text" class="form-control" name="character" id="character" 
                                           placeholder="Character name">
                                    <small class="form-text text-muted">Searches by partial match</small>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Item IDs</label>
                                    <input type="text" class="form-control" name="itemIds" id="itemIds" 
                                           placeholder="Example: 810603,827319"
                                           onkeypress="return isNumberKey(event)">
                                    <small class="form-text text-muted">Comma separated, numbers only</small>
                                </div>
                                <div class="col-md-3">
                                    <button type="button" class="btn btn-primary w-100" id="searchMailBtn">
                                        <i class="bi bi-envelope"></i> Items in the mailbox
                                    </button>
                                    <button type="button" class="btn btn-success w-100 mt-2" id="searchGiftboxBtn">
                                        <i class="bi bi-gift"></i> Items at the post office (service)
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Legend -->
                <div class="legend-container">
                    <strong><i class="bi bi-info-circle"></i> Tracking Legend:</strong>
                    <div class="legend-item">
                        <i class="bi bi-envelope-check text-success legend-icon" title="In Mail"></i>
                        <span>In Mail</span>
                    </div>
                    <div class="legend-item">
                        <i class="bi bi-check-circle text-secondary legend-icon" title="Received"></i>
                        <span>Received</span>
                    </div>
                    <div class="legend-item">
                        <i class="bi bi-archive text-danger legend-icon" title="Used"></i>
                        <span>Used</span>
                    </div>
                    <div class="legend-item">
                        <i class="bi bi-star-fill text-warning legend-icon" title="Service Item"></i>
                        <span>Service Item</span>
                    </div>
                    <div class="legend-item">
                        <i class="bi bi-circle text-primary legend-icon" title="Regular Item"></i>
                        <span>Regular Item</span>
                    </div>
                    <div class="legend-item">
                        <i class="bi bi-trash text-danger legend-icon" title="Can be deleted"></i>
                        <span>Can be deleted (In Mail only)</span>
                    </div>
                </div>

                <!-- Tabs -->
                <ul class="nav nav-tabs item-tracking-nav-tabs" id="trackingTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="mail-tab" data-bs-toggle="tab" data-bs-target="#mail" 
                                type="button" role="tab" aria-selected="true">
                            <i class="bi bi-envelope me-1"></i>Item Mail Box Tracking
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="giftbox-tab" data-bs-toggle="tab" data-bs-target="#giftbox" 
                                type="button" role="tab" aria-selected="false">
                            <i class="bi bi-gift me-1"></i>Items at the post office Tracking
                        </button>
                    </li>
                </ul>

                <!-- Tab Content -->
                <div class="tab-content" id="trackingTabContent">
                    <!-- Mail Tracking Tab -->
                    <div class="tab-pane fade show active" id="mail" role="tabpanel" aria-labelledby="mail-tab">
                        <div class="card item-tracking-card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6 class="mb-0">
                                        <i class="bi bi-envelope me-2"></i>Item Mail Box Tracking Results
                                    </h6>
                                    <span id="mailCount" class="badge bg-primary">0 records</span>
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-striped table-hover item-tracking-table" id="mailTable">
                                        <thead>
                                            <tr>
                                                <th>#</th>
                                                <th>Content</th>
                                                <th>Gold</th>
                                                <th>Sender User</th>
                                                <th>Recipient User</th>
                                                <th>Sender Character</th>
                                                <th>Recipient Character</th>
                                                <th>Send Time</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td colspan="8" class="text-center">No data loaded yet. Use search to load data.</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Giftbox Tracking Tab -->
                    <div class="tab-pane fade" id="giftbox" role="tabpanel" aria-labelledby="giftbox-tab">
                        <div class="card item-tracking-card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6 class="mb-0">
                                        <i class="bi bi-gift me-2"></i>Items at the post office Tracking Results
                                    </h6>
                                    <span id="giftboxCount" class="badge bg-primary">0 records</span>
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-striped table-hover item-tracking-table" id="giftboxTable">
                                        <thead>
                                            <tr>
                                                <th>#</th>
                                                <th>Item ID</th>
                                                <th>Item Name</th>
                                                <th>Quantity</th>
                                                <th>User</th>
                                                <th>Owner</th>
                                                <th class="text-center">Status</th>
                                                <th class="text-center">Type</th>
                                                <th>Time</th>
                                                <th class="text-center">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td colspan="10" class="text-center">No data loaded yet. Use search to load data.</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <%- include('partials/adminFooter') %>
    <%- include('partials/itemTrackingInfoModal') %>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteModalLabel">
                        <i class="bi bi-trash me-2"></i>Item Deletion
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete this item from the gift box?</p>
                    <div class="alert alert-warning">
                        <strong><i class="bi bi-exclamation-triangle"></i> Warning!</strong> This action cannot be undone. The item will be completely removed from the system.
                    </div>
                    <div id="deleteItemInfo"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                        <i class="bi bi-trash"></i> Delete Item
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="/node_modules/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/admin-itemTracking.js"></script>
    <script>
        // Initialize the application with the current user ID
        document.addEventListener('DOMContentLoaded', function() {
            // Set the current user ID from server-side template
            if (typeof ItemTrackingApp !== 'undefined') {
                ItemTrackingApp.init('<%= userId %>');
            }
        });
    </script>
</body>
</html>