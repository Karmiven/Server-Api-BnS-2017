<!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>Profile: <%= UserName %></title>
      <link rel="icon" href="images/favicon.png" type="image/png">
      <link rel="stylesheet" href="css/navbar.css">
      <link rel="stylesheet" href="css/preloader.css">
      <link href="/node_modules/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
      <link rel="stylesheet" href="css/profile.css">
      <link rel="stylesheet" href="/node_modules/sweetalert2/dist/sweetalert2.min.css">
      <link rel="stylesheet" href="/node_modules/@fortawesome/fontawesome-free/css/all.min.css">
   </head>
   <body>
      <div id="preloader">
         <div class="bns"></div>
      </div>
      <%- include('partials/navbar') %>
      <div class="container">
         <% if (typeof errorMessage !== 'undefined' && errorMessage) { %>
         <div class="position-fixed top-0 start-0 w-100 h-100 d-flex justify-content-center align-items-center" style="background-color: rgba(0,0,0,0.5); z-index: 1050;">
            <div class="alert alert-danger text-center" role="alert" style="width: 400px;">
               <i class="fas fa-exclamation-triangle me-2"></i>
               <%= errorMessage %>
            </div>
         </div>
         <% } else { %>
         <!-- Профиль пользователя -->
         <div class="profile-section">
            <div class="profile-card">
               <div class="profile-header">
                  <h3><%= UserName %></h3>
               </div>
               <div class="profile-body">
                  <div class="avatar-container">
                     <img src="/images/avatars/<%= currentAvatar %>" alt="User Avatar" class="user-avatar">
                     <div class="avatar-edit-icon" id="avatarEditIcon">
                        <i class="fas fa-pencil-alt"></i>
                     </div>
                  </div>
                  <div class="profile-info">
                     <p>Email: <%= LoginName %></p>
                     <p>Created: <%= Created %></p>
                     <p>Last Login: <%= lastLoginTime %></p>
                     <p>Last Logout: <%= lastLogoutTime %></p>
                     <p>Last IP: <%= lastAccessIP %></p>
                     <% if (statusMessage.imageUrl) { %>
                     <div class="vip-status">
                        <img src="<%= statusMessage.imageUrl %>" alt="VIP Status" class="vip-status-image">
                        <span style="color: <%= statusMessage.color %>;"><%= statusMessage.message %></span>
                     </div>
                     <% } %>
                     <p>VIP Level: <%= vipLevel %></p>
                     <p>VIP Expiration: <%= expirationDate ? new Date(expirationDate).toLocaleString('en-GB') : 'Not set' %></p>
                     <% if (activeBan) { %>
                     <div class="ban-status" style="margin-top: 10px; padding: 10px; background-color: #ff0000; border-radius: 4px; border-left: 4px solid #000000;">
                        <p style="margin: 0; color: #ffffff; font-weight: bold; font-size: 16px;">
                           <i class="fas fa-ban" style="margin-right: 5px;"></i> ACCOUNT BANNED
                        </p>
                        <p style="margin: 8px 0 0 0; color: #ffffff;"><strong style="color: #ffffff;">Reason:</strong> <%= activeBan.BanReason %></p>
                        <p style="margin: 5px 0 0 0; color: #ffffff;"><strong style="color: #ffffff;">Until:</strong> <%= new Date(activeBan.EffectiveTo).toLocaleString('en-GB') %></p>
                     </div>
                     <% } %>
                  </div>
                  <!-- Кнопки переключения -->
                  <div class="profile-actions">
                     <button class="profile-btn active" id="btnCharacters">Characters</button>
                     <button class="profile-btn" id="btnPromoCode">Promo code</button>
                  </div>
               </div>
            </div>
         </div>
         <div class="content-section">
            <!-- Блок Characters (по умолчанию видимый) -->
            <div class="data-card" id="charactersSection">
               <div class="card-title">
                  <i class="fas fa-users"></i> Characters
               </div>
               <div class="card-content">
                  <table class="characters-table">
                     <thead>
                        <tr>
                           <th>Name</th>
                           <th>Server</th>
                           <th>Level</th>
                           <th>Class</th>
                           <th>Race</th>
                           <th>Gender</th>
                           <th>Faction</th>
                           <th>Money</th>
                        </tr>
                     </thead>
                     <tbody>
                        <% if (creatures && creatures.length > 0) { %>
                        <% creatures.forEach(creature => { %>
                        <% if (creature.deletion !== 1) { %>
                        <tr>
                           <td><%= creature.name %></td>
                           <td><%= creature.worldName %></td>
                           <td><%= creature.level %></td>
                           <td>
                              <div class="table-image-text">
                                 <img src="<%= creature.jobImageUrl %>" alt="<%= creature.job %>" class="image-small">
                                 <span><%= creature.job %></span>
                              </div>
                           </td>
                           <td>
                              <div class="table-image-text">
                                 <img src="<%= creature.raceImageUrl %>" alt="<%= creature.race %>" class="image-small">
                              </div>
                           </td>
                           <td>
                              <div class="table-image-text">
                                 <i class="<%= creature.sexIconClass %>"></i>
                                 <span><%= creature.sex %></span>
                              </div>
                           </td>
                           <td>
                              <div class="table-image-text">
                                 <img src="<%= creature.factionImageUrl %>" alt="<%= creature.faction %>" class="image-small">
                              </div>
                           </td>
                           <td>
                              <div class="money-display" style="display: inline-block;">
                                 <img src="<%= creature.money.gold.imageUrl %>" alt="Gold" class="money-icon">
                                 <span class="money-value"><%= creature.money.gold.value %></span>
                              </div>
                              <div class="money-display" style="display: inline-block;">
                                 <img src="<%= creature.money.silver.imageUrl %>" alt="Silver" class="money-icon">
                                 <span class="money-value"><%= creature.money.silver.value %></span>
                              </div>
                              <div class="money-display" style="display: inline-block;">
                                 <img src="<%= creature.money.copper.imageUrl %>" alt="Copper" class="money-icon">
                                 <span class="money-value"><%= creature.money.copper.value %></span>
                              </div>
                           </td>
                        </tr>
                        <% } %>
                        <% }) %>
                        <% } else { %>
                        <tr>
                           <td colspan="8" style="text-align: center; padding: 20px; color: var(--text-secondary);">
                              No characters found
                           </td>
                        </tr>
                        <% } %>
                     </tbody>
                  </table>
                  <div class="characters-mobile">
                     <% if (creatures && creatures.length > 0) { %>
                     <% creatures.forEach(creature => { %>
                     <% if (creature.deletion !== 1) { %>
                     <div class="character-card">
                        <div class="character-name"><%= creature.name %></div>
                        <div class="character-server">BnS Private • Level <%= creature.level %></div>
                        <div class="character-detail">
                           <span class="detail-label">Class</span>
                           <span class="detail-value">
                           <img src="<%= creature.jobImageUrl %>" alt="<%= creature.job %>" class="image-small">
                           <%= creature.job %>
                           </span>
                        </div>
                        <div class="character-detail">
                           <span class="detail-label">Race</span>
                           <span class="detail-value">
                           <img src="<%= creature.raceImageUrl %>" alt="<%= creature.race %>" class="image-small">
                           <%= creature.race %>
                           </span>
                        </div>
                        <div class="character-detail">
                           <span class="detail-label">Sex</span>
                           <span class="detail-value">
                           <i class="<%= creature.sexIconClass %>"></i>
                           <%= creature.sex %>
                           </span>
                        </div>
                        <div class="character-detail">
                           <span class="detail-label">Faction</span>
                           <span class="detail-value">
                           <img src="<%= creature.factionImageUrl %>" alt="<%= creature.faction %>" class="image-small">
                           <%= creature.faction %>
                           </span>
                        </div>
                        <div class="character-created">
                           Created: <%= new Date(creature.created).toLocaleString('en-GB') %>
                        </div>
                     </div>
                     <% } %>
                     <% }) %>
                     <% } else { %>
                     <div style="text-align: center; padding: 20px; color: var(--text-secondary);">
                        No characters found
                     </div>
                     <% } %>
                  </div>
               </div>
            </div>
            <!-- Блок Deposit Information -->
            <div class="data-card" id="depositSection">
               <div class="card-title">
                  <i class="fas fa-wallet"></i> Deposit Information
               </div>
               <div class="card-content">
                  <% if (deposits && deposits.length > 0) { %>
                  <div class="deposit-grid">
                     <div class="deposit-item">
                        <div class="deposit-label">Total Amount</div>
                        <div class="deposit-value">
                           <img src="/images/money/NCoin.webp" alt="Coins" class="coin-icon">
                           <%= totalAmount %> Hangmoon Coins
                        </div>
                     </div>
                     <div class="deposit-item">
                        <div class="deposit-label">Total Balance</div>
                        <div class="deposit-value">
                           <img src="/images/money/NCoin.webp" alt="Coins" class="coin-icon">
                           <%= totalBalance %> Hangmoon Coins
                        </div>
                     </div>
                  </div>
                  <% } else { %>
                  <div style="text-align: center; padding: 20px; color: var(--text-secondary);">
                     Player's account balance data not found
                  </div>
                  <% } %>
               </div>
            </div>
            <!-- Блок Promo Code (по умолчанию скрытый) -->
            <div class="data-card section-hidden" id="promoCodeSection">
               <div class="card-title">
                  <i class="fas fa-ticket-alt"></i> Promo Code Activation
               </div>
               <div class="card-content">
                  <div style="padding: 20px;">
                     <form id="couponForm">
                        <div class="mb-3">
                           <label for="couponCode" class="form-label" style="color: var(--text-secondary);">Enter coupon code:</label>
                           <div class="input-group">
                              <input type="text" class="form-control" id="couponCode" 
                                 placeholder="Enter coupon code" 
                                 style="background: var(--card-bg); color: var(--text-primary); border-color: var(--border-color);">
                              <button class="btn btn-primary" type="submit" 
                                 style="background: var(--primary-accent); border-color: var(--primary-accent);">
                              Activate
                              </button>
                           </div>
                        </div>
                     </form>
                  </div>
               </div>
            </div>
            <!-- Блок History (по умолчанию скрытый) -->
            <div class="data-card section-hidden" id="historySection">
               <div class="card-title">
                  <i class="fas fa-history"></i> Activation History
               </div>
               <div class="card-content" style="min-height: 200px;">
                  <div style="padding: 20px;">
                     <div id="couponHistory" class="coupon-history">
                        <div style="text-align: center; color: var(--text-secondary); padding: 20px;">
                           Loading activation history...
                        </div>
                     </div>
                  </div>
               </div>
            </div>
         </div>
         <!-- content-section -->
         <% } %>
      </div>
      <!-- container -->
      <!-- Контейнер для уведомлений (всегда есть в DOM) -->
      <div id="couponResult"></div>
      <!-- Скрытые данные для JavaScript -->
      <div id="profileData" style="display: none;" 
         data-user-id="<%= UserId %>"
         data-user-name="<%= UserName %>"></div>
      <footer class="custom-footer">
         <p>&copy; 2024 Blade & Soul: Private Server</p>
         <p>All rights reserved.</p>
      </footer>
      <%- include('partials/signupModal') %>
      <%- include('partials/signinModal') %>
      <% if (activeBan) { %>
      <div id="ban-data" 
         data-ban-reason="<%= activeBan.BanReason %>" 
         data-ban-until="<%= new Date(activeBan.EffectiveTo).toLocaleString('en-GB') %>"
         style="display: none;"></div>
      <% } %>
      <!-- Скрипты -->
      <script src="/node_modules/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
      <script src="/js/preloader.js"></script>
      <script src="/js/navbar.min.js"></script>
      <script src="/node_modules/sweetalert2/dist/sweetalert2.all.min.js"></script>
      <script src="/js/profile.js"></script>
      <script src="/js/couponManager.js"></script>
      <script src="/js/banAlert.js"></script>
   </body>
</html>