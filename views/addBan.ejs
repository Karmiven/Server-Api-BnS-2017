<!DOCTYPE html>
<html lang="en">
   <!-- <html lang="en" data-bs-theme="dark"> -->
   <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>Ban Management</title>
      <link rel="icon" href="/images/favicon-admin.png" type="image/png">
      <link href="/node_modules/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
      <link rel="stylesheet" href="/node_modules/bootstrap-icons/font/bootstrap-icons.css">
      <link rel="stylesheet" href="/node_modules/@fortawesome/fontawesome-free/css/all.min.css">
   </head>
   <body class="bg-body-tertiary">
      <%- include('partials/nav') %>
      <!-- Toast container (positioned top-right) -->
      <div id="toastContainer" class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1100"></div>
      <main class="flex-grow-1 pb-5">
         <div class="container py-4">
            <!-- Заголовок и информация о пользователе -->
            <div class="d-flex justify-content-between align-items-center mb-4 flex-column flex-md-row">
               <div class="account-management-block mb-4 mb-md-0 p-3 rounded-3 shadow-sm" style="background-color: #f8f9fa; border-left: 4px solid #dc3545;">
                  <h2 class="mb-3 d-flex align-items-center">
                     <i class="fas fa-gavel fs-4 text-danger me-2"></i>Ban Management
                  </h2>
                  <div class="d-flex flex-wrap align-items-center gap-2 mb-2">                 
                     <span class="badge bg-secondary py-2 px-3 d-flex align-items-center">
                     <i class="fas fa-id-card me-2"></i>
                     <span class="fw-medium">User ID: <%= userId %></span>
                     </span>
                     <span class="badge bg-success py-2 px-3 d-flex align-items-center">
                     <i class="fas fa-user me-2"></i>
                     <a href="/profile?userName=<%= userName %>" target="_blank" rel="noopener noreferrer" class="text-white text-decoration-none fw-medium"><%= userName %></a>
                     </span>
                  </div>
                  <span id="banStatusBadge" class="badge <%= (bans && bans.some(ban => ban.UnbanStatus === 1)) ? 'bg-danger' : 'bg-success' %> py-1 px-2">
                  <i class="fas <%= (bans && bans.some(ban => ban.UnbanStatus === 1)) ? 'fa-ban' : 'fa-check' %> me-1"></i>
                  <small>Status Banned: <%= (bans && bans.some(ban => ban.UnbanStatus === 1)) ? 'Active' : 'None' %></small>
                  </span>
               </div>
               <!-- dropdown меню -->
               <div class="d-flex ms-md-auto mt-3 mt-md-0">
                  <div class="dropdown">
                     <button class="btn btn-sm btn-outline-danger dropdown-toggle py-1 px-2" type="button" id="userActionsDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                     <i class="fas fa-user-cog fa-sm me-1"></i> Actions
                     </button>
                     <ul class="dropdown-menu dropdown-menu-end shadow-sm" aria-labelledby="userActionsDropdown">
                        <li>
                           <h6 class="dropdown-header">User Actions</h6>
                        </li>
                        <li>
                           <a class="dropdown-item py-2" href="edit-character?userId=<%= userId %>">
                           <i class="fas fa-user-edit fa-fw me-2 text-primary"></i>Edit Character
                           </a>
                        </li>
                        <li>
                           <a class="dropdown-item py-2" href="add-deposit?userId=<%= userId %>">
                           <i class="fas fa-coins fa-fw me-2 text-success"></i>Add Deposit
                           </a>
                        </li>
                        <li>
                           <a class="dropdown-item py-2" href="add-item?userId=<%= userId %>">
                           <i class="fas fa-paper-plane fa-fw me-2 text-info"></i>Sending Items
                           </a>
                        </li>
                        <li>
                           <hr class="dropdown-divider my-1">
                        </li>
                        <li>
                           <h6 class="dropdown-header">Administration</h6>
                        </li>
                        <li>
                           <a class="dropdown-item py-2" href="add-vip?userId=<%= userId %>">
                           <i class="fas fa-crown fa-fw me-2 text-warning"></i>VIP Management
                           </a>
                        </li>
                     </ul>
                  </div>
                  <button class="btn btn-sm btn-outline-danger ms-2 py-1 px-2" data-bs-toggle="modal" data-bs-target="#banInfoModal">
                  <i class="fas fa-info-circle fa-sm me-1"></i> Info
                  </button>
               </div>
            </div>
            <div class="card shadow-sm">
               <div class="card-header bg-danger text-white">
                  <h2 class="h5 mb-0"><i class="bi bi-shield-lock me-2"></i>Ban Users</h2>
               </div>
               <div class="card-body">
                  <!-- Скрытое поле для имени пользователя -->
                  <input type="hidden" id="userName" value="<%= userName %>">
                  <div class="alert alert-info">
                     <h5 class="alert-heading"><i class="bi bi-info-circle-fill me-2"></i>Ban Process Information</h5>
                     <hr>
                     <p class="mb-0">
                        After banning, the user will be disconnected in 1 minute. A 3-minute timer will start to restart the "BanSrv" service. 
                        <span class="d-block mt-1 fw-semibold">New bans cannot be added during service restart.</span>
                     </p>
                  </div>
                  <form id="banForm" action="/admin/add-ban" class="mb-4">
                     <input type="hidden" name="userId" id="userId" value="<%= userId %>">
                     <div class="row g-3">
                        <div class="col-md-6">
                           <label for="reason" class="form-label fw-bold"><i class="bi bi-chat-square-text text-danger me-1"></i> Ban Reason</label>
                           <select class="form-select" id="reason" name="reason" required>
                              <% if (banReasons && banReasons.length > 0) { %>
                              <% banReasons.forEach(reason => { %>
                              <option value="<%= reason.BanReasonCode %>">
                                 <%= reason.BanReason %>
                              </option>
                              <% }) %>
                              <% } else { %>
                              <option disabled>No ban reasons available</option>
                              <% } %>
                           </select>
                        </div>
                        <div class="col-md-6">
                           <label for="duration" class="form-label fw-bold"><i class="bi bi-clock text-danger me-1"></i> Ban Duration</label>
                           <select class="form-select" id="duration" name="duration" required>
                              <option value="1">1 Hour</option>
                              <option value="24">1 Day</option>
                              <option value="168">1 Week</option>
                              <option value="720">1 Month</option>
                              <option value="permanent">Permanent</option>
                           </select>
                        </div>
                     </div>
                     <div class="d-flex gap-2 mt-4">
                        <button type="submit" class="btn btn-danger flex-grow-1">
                        <i class="bi bi-ban me-1"></i> Add Ban
                        </button>
                        <button type="button" id="kickUserBtn" class="btn btn-warning flex-grow-1">
                        <i class="bi bi-person-dash me-1"></i> Kick User
                        </button>
                     </div>
                     <div id="countdownContainer" class="d-none mt-3">
                        <div class="alert alert-warning d-flex align-items-center">
                           <i class="bi bi-clock-history me-2 fs-5"></i>
                           <div>
                              Restarting BanSrv, available in <span id="countdownTimer" class="fw-bold">3:00</span>
                           </div>
                        </div>
                     </div>
                  </form>
                  <hr class="my-4">
                  <h3 class="h5 mb-3"><i class="bi bi-list-check text-danger me-2"></i>Active Bans</h3>
                  <div id="bansContainer">
                     <% if (bans && bans.length > 0) { %>
                     <div class="table-responsive">
                        <table class="table table-hover table-sm align-middle">
                           <thead class="table-light">
                              <tr>
                                 <th><i class="bi bi-hash me-1"></i> ID</th>
                                 <th><i class="bi bi-calendar-plus me-1"></i> From</th>
                                 <th><i class="bi bi-calendar-x me-1"></i> To</th>
                                 <th><i class="bi bi-chat-left-text me-1"></i> Reason</th>
                                 <th><i class="bi bi-circle-fill me-1"></i> Status</th>
                                 <th><i class="bi bi-gear me-1"></i> Actions</th>
                              </tr>
                           </thead>
                           <tbody class="table-group-divider">
                              <% bans.forEach(ban => { %>
                              <tr>
                                 <td><%= ban.BanId %></td>
                                 <td><%= new Date(ban.EffectiveFrom).toLocaleString() %></td>
                                 <td><%= new Date(ban.EffectiveTo).toLocaleString() %></td>
                                 <td><%= ban.BanReason %></td>
                                 <td>
                                    <span class="badge <%= ban.UnbanStatus === 1 ? 'bg-danger' : 'bg-success' %>">
                                    <i class="bi <%= ban.UnbanStatus === 1 ? 'bi-x-circle' : 'bi-check-circle' %> me-1"></i>
                                    <%= ban.UnbanStatus === 1 ? 'Active' : 'Inactive' %>
                                    </span>
                                 </td>
                                 <td>
                                    <% if (ban.UnbanStatus === 1) { %>
                                    <button class="btn btn-sm btn-outline-success unban-btn" data-ban-id="<%= ban.BanId %>">
                                    <i class="bi bi-unlock me-1"></i> Unban
                                    </button>
                                    <% } %>
                                 </td>
                              </tr>
                              <% }) %>
                           </tbody>
                        </table>
                     </div>
                     <% } else { %>
                     <div class="alert alert-secondary mb-0">
                        <i class="bi bi-emoji-frown me-2"></i> No active bans for this user.
                     </div>
                     <% } %>
                  </div>
               </div>
            </div>
         </div>
      </main>
      <%- include('partials/banInfoModal') %>
      <%- include('partials/adminFooter') %>
      <script src="/node_modules/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
      <script src="/js/admin-ban.js"></script>
   </body>
</html>