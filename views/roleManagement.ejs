<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Role Management</title>
  <link rel="icon" href="/images/favicon-admin.png" type="image/png">
  <link href="/node_modules/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/node_modules/@fortawesome/fontawesome-free/css/all.min.css">
  <link rel="stylesheet" href="/css/admin-promotions.css">
</head>
<body class="bg-light d-flex flex-column min-vh-100">
  <%- include('partials/nav') %>
  <main class="flex-grow-1 pb-5">
    <div class="container py-4">
      <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between mb-4">
        <div class="d-flex align-items-center mb-3 mb-md-0">
          <div class="bg-primary bg-opacity-10 p-3 rounded-3 me-3">
            <i class="fas fa-user-shield fa-lg text-primary"></i>
          </div>
          <div>
            <h2 class="h4 mb-0">Server Role Management</h2>
            <p class="text-muted mb-0">Manage user roles and permissions</p>
          </div>
        </div>
        <div class="d-flex flex-wrap gap-2 align-items-center">
          <button class="btn btn-outline-primary btn-sm" id="refreshBtn">
            <i class="fas fa-sync-alt me-1"></i>Refresh
          </button>
          <button class="btn btn-sm btn-primary" id="addRoleBtn" data-bs-toggle="modal" data-bs-target="#roleAddModal">
            <i class="fas fa-user-plus me-1"></i>Add Role
          </button>
          <button class="btn btn-sm info-btn" id="infoBtn" data-bs-toggle="modal" data-bs-target="#roleInfoModal">
            <i class="fas fa-info-circle me-1"></i>Info
          </button>
        </div>
      </div>

      <div class="row mb-4">
        <div class="col-md-6 mb-3 mb-md-0">
          <div class="card h-100 stat-card">
            <div class="card-header bg-white">
              <h4 class="section-header">
                <i class="fas fa-chart-line text-primary me-2"></i>Role Statistics
              </h4>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-6 mb-3">
                  <div class="bg-light p-3 rounded text-center h-100">
                    <div class="text-primary mb-1">
                      <i class="fas fa-users fa-2x"></i>
                    </div>
                    <h5 class="mb-0"><%= userRoles.length %></h5>
                    <small class="text-muted">Users with Roles</small>
                  </div>
                </div>
                <div class="col-6 mb-3">
                  <div class="bg-light p-3 rounded text-center h-100">
                    <div class="text-success mb-1">
                      <i class="fas fa-user-tag fa-2x"></i>
                    </div>
                    <h5 class="mb-0"><%= userRoles.reduce((sum, user) => sum + user.Roles.length, 0) %></h5>
                    <small class="text-muted">Total Roles Assigned</small>
                  </div>
                </div>
                <div class="col-6">
                  <div class="bg-light p-3 rounded text-center h-100">
                    <div class="text-info mb-1">
                      <i class="fas fa-database fa-2x"></i>
                    </div>
                    <h5 class="mb-0">RoleDB</h5>
                    <small class="text-muted">Database</small>
                  </div>
                </div>
                <div class="col-6">
                  <div class="bg-light p-3 rounded text-center h-100">
                    <div class="text-secondary mb-1">
                      <i class="fas fa-server fa-2x"></i>
                    </div>
                    <h5 class="mb-0">RoleSrv</h5>
                    <small class="text-muted">Service</small>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card h-100 stat-card">
            <div class="card-header bg-white">
              <h4 class="section-header">
                <i class="fas fa-info-circle text-primary me-2"></i>System Overview
              </h4>
            </div>
            <div class="card-body">
              <div class="d-flex flex-column h-100">
                <div class="d-flex justify-content-between py-2 border-bottom">
                  <span class="text-muted">
                    <i class="fas fa-clock me-2"></i>Last Updated
                  </span>
                  <span id="lastUpdatedTime"><%= new Date().toLocaleString() %></span>
                </div>
                <div class="d-flex justify-content-between py-2 border-bottom">
                  <span class="text-muted">
                    <i class="fas fa-server me-2"></i>Service Status
                  </span>
                  <span class="badge <%= serviceStatus === 'Running' ? 'bg-success' : 'bg-danger' %>">
                    <%= serviceStatus %> (<%= currentVersion %>)
                  </span>
                </div>
                <div class="d-flex justify-content-between py-2">
                  <span class="text-muted">
                    <i class="fas fa-user-shield me-2"></i>Admin Access
                  </span>
                  <span class="badge bg-primary">Enabled</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="card border-0 shadow-sm">
        <div class="card-header bg-white border-0 py-3">
          <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center">
            <h3 class="h5 mb-2 mb-md-0">
              <i class="fas fa-list-ol text-primary me-2"></i>Current User Roles
            </h3>
            <div class="d-flex align-items-center">
              <span class="badge bg-light text-dark me-2">
                <i class="fas fa-filter me-1"></i>All
              </span>
            </div>
          </div>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
              <thead class="table-light">
                <tr>
                  <th class="py-3 table-header"><i class="fas fa-hashtag me-2"></i>User ID</th>
                  <th class="py-3 table-header"><i class="fas fa-user me-2"></i>User Name</th>
                  <th class="py-3 table-header"><i class="fas fa-layer-group me-2"></i>App Group ID</th>
                  <th class="py-3 table-header"><i class="fas fa-user-tag me-2"></i>Role</th>
                  <th class="py-3 table-header"><i class="fas fa-calendar-alt me-2"></i>Registered</th>
                  <th class="py-3 table-header text-end"><i class="fas fa-cogs me-2"></i>Actions</th>
                </tr>
              </thead>
              <tbody>
                <% if (userRoles && userRoles.length > 0) { %>
                  <% userRoles.forEach(user => { %>
                    <% user.Roles.forEach(role => { %>
                      <tr>
                        <td class="fw-semibold d-none d-md-table-cell">
                          <i class="fas fa-hashtag table-icon"></i>
                          <%= user.UserId %>
                        </td>
                        <td class="fw-medium d-none d-md-table-cell">
                          <i class="fas fa-user table-icon"></i>
                          <%= user.UserName %>
                        </td>
                        <td class="d-none d-md-table-cell">
                          <i class="fas fa-layer-group table-icon"></i>
                          <%= user.AppGroupId %>
                        </td>
                        <td class="d-none d-md-table-cell">
                          <i class="fas fa-user-tag table-icon"></i>
                          <%= role.RoleName %>
                        </td>
                        <td class="d-none d-md-table-cell">
                          <i class="fas fa-calendar-alt table-icon"></i>
                          <%= new Date(role.Registered).toLocaleString() %>
                        </td>
                        <td class="d-none d-md-table-cell">
                          <div class="d-flex justify-content-end gap-2">
                            <button class="btn btn-sm btn-outline-danger remove-role-btn"
                                    data-user-id="<%= user.UserId %>"
                                    data-user-center="17"
                                    data-app-group-id="<%= user.AppGroupId %>"
                                    data-role-id="<%= role.RoleId %>">
                              <i class="fas fa-trash-alt me-1"></i>Remove
                            </button>
                          </div>
                        </td>
                      </tr>
                      <!-- Mobile view - stacked -->
                      <tr class="d-md-none">
                        <td colspan="6" class="p-3">
                          <div class="d-flex flex-column gap-2">
                            <div><strong>User ID:</strong> <%= user.UserId %></div>
                            <div><strong>User Name:</strong> <%= user.UserName %></div>
                            <div><strong>App Group ID:</strong> <%= user.AppGroupId %></div>
                            <div><strong>Role:</strong> <%= role.RoleName %></div>
                            <div><strong>Registered:</strong> <%= new Date(role.Registered).toLocaleString() %></div>
                            <div class="d-flex gap-2">
                              <button class="btn btn-sm btn-outline-danger remove-role-btn"
                                      data-user-id="<%= user.UserId %>"
                                      data-user-center="17"
                                      data-app-group-id="<%= user.AppGroupId %>"
                                      data-role-id="<%= role.RoleId %>">
                                <i class="fas fa-trash-alt me-1"></i>Remove
                              </button>
                            </div>
                          </div>
                        </td>
                      </tr>
                    <% }) %>
                  <% }) %>
                <% } else { %>
                  <tr>
                    <td colspan="6" class="text-center text-muted py-4">No user roles found.</td>
                  </tr>
                <% } %>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </main>
  <%- include('partials/adminFooter') %>
  <%- include('partials/roleInfoModal') %>
  <%- include('partials/roleAddModal') %>

  <script src="/node_modules/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    document.getElementById('refreshBtn').addEventListener('click', () => {
      document.getElementById('lastUpdatedTime').textContent = new Date().toLocaleString();
      location.reload();
    });

    document.getElementById('addRoleForm')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const userId = document.getElementById('userId').value;
      const userCenter = document.getElementById('userCenter').value;
      const appGroupId = document.getElementById('appGroupId').value;
      const roleId = document.getElementById('roleId').value;
      
      const resultAlert = document.getElementById('resultAlert');
      resultAlert.classList.add('d-none');
      
      try {
        const response = await fetch(`/admin/role-management/add_user_role?userId=${userId}&userCenter=${userCenter}&appGroupId=${appGroupId}&roleId=${roleId}`);
        const data = await response.json();
        
        if (response.ok) {
          resultAlert.classList.remove('alert-danger');
          resultAlert.classList.add('alert-success');
          resultAlert.textContent = 'Role added successfully.';
          setTimeout(() => {
            bootstrap.Modal.getInstance(document.getElementById('roleAddModal')).hide();
            location.reload();
          }, 1000);
        } else {
          resultAlert.classList.remove('alert-success');
          resultAlert.classList.add('alert-danger');
          resultAlert.textContent = data.error || 'Failed to add role';
        }
      } catch (error) {
        resultAlert.classList.remove('alert-success');
        resultAlert.classList.add('alert-danger');
        resultAlert.textContent = 'Network error: ' + error.message;
      }
      
      resultAlert.classList.remove('d-none');
    });

    document.querySelectorAll('.remove-role-btn').forEach(button => {
      button.addEventListener('click', async () => {
        const userId = button.getAttribute('data-user-id');
        const userCenter = button.getAttribute('data-user-center');
        const appGroupId = button.getAttribute('data-app-group-id');
        const roleId = button.getAttribute('data-role-id');
        
        try {
          const response = await fetch(`/admin/role-management/remove_user_role?userId=${userId}&userCenter=${userCenter}&appGroupId=${appGroupId}&roleId=${roleId}`);
          const data = await response.json();
          
          const resultAlert = document.createElement('div');
          resultAlert.className = 'alert mt-3';
          document.querySelector('.container').prepend(resultAlert);
          
          if (response.ok) {
            resultAlert.classList.remove('alert-danger');
            resultAlert.classList.add('alert-success');
            resultAlert.textContent = 'Role removed successfully.';
            setTimeout(() => location.reload(), 1000);
          } else {
            resultAlert.classList.remove('alert-success');
            resultAlert.classList.add('alert-danger');
            resultAlert.textContent = data.error || 'Failed to remove role';
          }
        } catch (error) {
          const resultAlert = document.createElement('div');
          resultAlert.className = 'alert mt-3 alert-danger';
          resultAlert.textContent = 'Network error: ' + error.message;
          document.querySelector('.container').prepend(resultAlert);
        }
      });
    });
  </script>
</body>
</html>