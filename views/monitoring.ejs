<!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>Monitoring Dashboard</title>
      <link rel="icon" href="/images/favicon-admin.png" type="image/png">
      <link href="/node_modules/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
      <link rel="stylesheet" href="/node_modules/bootstrap-icons/font/bootstrap-icons.css">
      <link rel="stylesheet" href="/node_modules/@fortawesome/fontawesome-free/css/all.min.css">
   </head>
   <body class="bg-light d-flex flex-column min-vh-100">
      <%- include('partials/nav') %>
      <main class="flex-grow-1 pb-5">
         <div class="container mt-4">
            <div class="card shadow-sm mb-4">
               <div class="card-body p-3">
                  <div class="d-flex justify-content-between align-items-center">
                     <div>
                        <h2 class="h4 mb-0"><i class="bi bi-graph-up text-primary me-2"></i>Player Monitoring</h2>
                        <p class="text-muted mb-0 small">Real-time player activity dashboard</p>
                     </div>
                     <div class="d-flex align-items-center">
                        <div class="me-4">
                           <span class="badge bg-success bg-opacity-10 text-success py-2 px-3">
                           <i class="bi bi-people-fill me-1"></i> 
                           <span class="fw-bold"><%= onlineCount %></span> Online Players
                           </span>
                           <span class="badge <%= presenceStatus === 'active' ? 'bg-success' : 'bg-danger' %> bg-opacity-10 <%= presenceStatus === 'active' ? 'text-success' : 'text-danger' %> py-2 px-3 ms-2">
                           <i class="bi <%= presenceStatus === 'active' ? 'bi-check-circle-fill' : 'bi-exclamation-triangle-fill' %> me-1"></i> 
                           <span class="fw-bold">PresenceSrv: <%= presenceStatus === 'active' ? 'Active' : 'Inactive' %></span>
                           </span>
                        </div>
                        <div class="btn-group">
                           <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#logModal">
                           <i class="bi bi-terminal me-1"></i> Raw Data
                           </button>
                           <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#discordBotModal">
                           <i class="bi bi-robot me-1"></i> Bot Settings
                           </button>
                        </div>
                     </div>
                  </div>
               </div>
            </div>
            <!-- Main Table Card -->
            <div class="card shadow-sm">
               <div class="card-body p-0">
                  <div class="table-responsive">
                     <table class="table table-hover mb-0">
                        <thead class="table-light">
                           <tr>
                              <th class="ps-4">#</th>
                              <th><i class="bi bi-building me-1 text-muted"></i> Center</th>
                              <th><i class="bi bi-controller me-1 text-muted"></i> Game</th>
                              <th><i class="bi bi-person-badge me-1 text-muted"></i> User ID</th>
                              <th><i class="bi bi-person me-1 text-muted"></i> Name</th>
                              <th><i class="bi bi-pc-display me-1 text-muted"></i> PC Name</th>
                              <th><i class="bi bi-globe me-1 text-muted"></i> IP Address</th>
                              <th><i class="bi bi-clock me-1 text-muted"></i> Login Time</th>
                              <th><i class="bi bi-circle-fill me-1 text-muted"></i> Status</th>
                              <th class="pe-4"><i class="bi bi-door-open me-1 text-muted"></i> Logins</th>
                           </tr>
                        </thead>
                        <tbody>
                           <% if (users.length > 0) { %>
                           <% users.forEach((user, index) => { %>
                           <tr class="align-middle">
                              <td class="ps-4"><span class="badge bg-light text-dark"><%= index + 1 %></span></td>
                              <td><%= user.UserCenter %></td>
                              <td><span class="badge bg-info bg-opacity-10 text-info"><%= user.GameCode %></span></td>
                              <td>
                                 <a href="/admin/edit-character?userName=<%= user.UserName %>" class="text-decoration-none">
                                 <i class="bi bi-box-arrow-up-right me-1 text-muted small"></i>
                                 <span class="text-primary"><%= user.UserId %></span>
                                 </a>
                              </td>
                              <td><%= user.UserName %></td>
                              <td><code><%= user.PcName._ %></code></td>
                              <td><%= user.ClientNetAddress %></td>
                              <td><small class="text-muted"><%= user.LoginTime %></small></td>
                              <td>
                                 <span class="badge bg-success bg-opacity-10 text-success">
                                 <i class="bi bi-check-circle-fill me-1"></i><%= user.Status %>
                                 </span>
                              </td>
                              <td class="pe-4">
                                 <span class="badge bg-primary bg-opacity-10 text-primary"><%= user.Logins %></span>
                              </td>
                           </tr>
                           <% }) %>
                           <% } else { %>
                           <tr>
                              <td colspan="10" class="text-center py-4">
                                 <div class="d-flex flex-column align-items-center justify-content-center text-muted py-5">
                                    <i class="bi bi-emoji-frown display-6 mb-3"></i>
                                    <h5 class="h5">No players online</h5>
                                    <p class="small">Waiting for player connections...</p>
                                 </div>
                              </td>
                           </tr>
                           <% } %>
                        </tbody>
                     </table>
                  </div>
               </div>
            </div>
         </div>
         <!-- Discord Bot Modal -->
         <%- include('partials/discordBotModal.ejs') %>
         <!-- Log Modal -->
         <%- include('partials/monitoringRawModal.ejs') %>
      </main>
      <%- include('partials/adminFooter') %>
      <script src="/node_modules/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
      <script src="/js/admin-monitoring.js"></script>
      <script>
         // Передаем переменные из EJS в JS
         const envBotEnabled = '<%= process.env.BOT_ENABLED %>' === 'false' ? false : true;
      </script>
   </body>
</html>