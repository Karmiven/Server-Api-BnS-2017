document.addEventListener("DOMContentLoaded", function() {
  // Функция для обновления аватара в навбаре
  function updateNavbarAvatar(avatarUrl) {
    const navbarAvatar = document.getElementById("navbarAvatar");
    if (navbarAvatar) {
      const finalAvatarUrl = avatarUrl || './images/avatars/user-avatar.gif';
      navbarAvatar.src = finalAvatarUrl;
    }
  }

  // Проверка авторизации и обновление навбара
  async function updateNavbar() {
    const username = localStorage.getItem("username");
    const profileLink = document.getElementById("profileLink");
    const usernameElement = document.getElementById("username");
    const usernameContainer = document.getElementById("usernameContainer");
    const signupContainer = document.getElementById("signupContainer");
    const currentPath = window.location.pathname;

    // Скрываем все элементы меню по умолчанию
    document.querySelectorAll('#homeItem, #aboutItem, #classesItem, #profsItem, #donateItem, #usernameContainer, #signupContainer').forEach(item => {
      if (item) item.classList.add("d-none");
    });

    if (username) {
      // Пользователь авторизован
      if (usernameElement) usernameElement.textContent = username;
      if (usernameContainer) usernameContainer.classList.remove("d-none");
      
      await fetchUserAvatar(username);
      
      if (profileLink) {
        profileLink.href = `/profile?userName=${encodeURIComponent(username)}`;
      }

      // Управление видимостью пунктов меню
      if (currentPath === "/profile") {
        document.getElementById("donateItem")?.classList.remove("d-none");
      } else if (currentPath === "/") {
        document.getElementById("aboutItem")?.classList.remove("d-none");
        document.getElementById("classesItem")?.classList.remove("d-none");
        document.getElementById("profsItem")?.classList.remove("d-none");
      }
    } else {
      // Пользователь не авторизован
      if (currentPath === "/") {
        if (signupContainer) signupContainer.classList.remove("d-none");
      }
    }
  }

  // Функция для получения аватара пользователя с сервера
  async function fetchUserAvatar(username) {
    try {
      const response = await fetch(`/api/user/avatar?userName=${encodeURIComponent(username)}`);
      if (response.ok) {
        const data = await response.json();
        if (data.avatarUrl) {
          updateNavbarAvatar(data.avatarUrl);
        } else {
          updateNavbarAvatar('./images/avatars/user-avatar.gif');
        }
      }
    } catch (error) {
      console.error("Failed to fetch user avatar:", error);
      updateNavbarAvatar('./images/avatars/user-avatar.gif');
    }
  }

  // Обработчик выхода
  document.getElementById("logoutLink")?.addEventListener("click", function(e) {
    e.preventDefault();
    localStorage.removeItem("username");
    updateNavbar();
    window.location.href = "/";
  });

  // Инициализация
  updateNavbar();

  // Плавная прокрутка для якорных ссылок
  document.querySelectorAll('a.nav-link[href^="#"]').forEach(anchor => {
    anchor.addEventListener("click", function(e) {
      e.preventDefault();
      const targetId = this.getAttribute("href").substring(1);
      const targetElement = document.getElementById(targetId);
      
      if (targetElement) {
        const navbarHeight = document.querySelector(".custom-navbar").offsetHeight;
        const targetPosition = targetElement.getBoundingClientRect().top + window.pageYOffset - navbarHeight;
        
        window.scrollTo({
          top: targetPosition,
          behavior: "smooth"
        });
      }
    });
  });
});